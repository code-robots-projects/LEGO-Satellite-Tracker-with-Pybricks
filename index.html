<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LEGO Satellite Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.1.3/satellite.min.js"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        .box { background: #1e293b; padding: 20px; border-radius: 15px; margin: 20px auto; max-width: 500px; border: 1px solid #334155; }
        button { padding: 15px; font-size: 18px; border-radius: 8px; border: none; cursor: pointer; width: 100%; margin-top: 10px; color: white; }
        .btn-green { background-color: #22c55e; }
        .btn-blue { background-color: #3b82f6; }
        .btn-red { background-color: #ef4444; }
        input { padding: 10px; margin: 5px; width: 100px; text-align: center; }
        .data { font-size: 1.5em; font-weight: bold; color: #fbbf24; }
    </style>
</head>
<body>

    <div class="box">
        <h2>1. Setup Location</h2>
        <button class="btn-blue" onclick="getLocation()">üìç Detect Location</button>
        <br><br>
        <input id="lat" placeholder="Lat"> <input id="lon" placeholder="Lon">
        <br>
        <button class="btn-blue" onclick="getData()">üì• Download Sat Data</button>
        <p id="status">Waiting for data...</p>
    </div>

    <div class="box">
        <h2>2. Connect Robot</h2>
        <p>Turn Hub ON. Wait for Green Light.</p>
        <button class="btn-green" id="conBtn" onclick="connect()">üì° Connect Bluetooth</button>
    </div>

    <div class="box">
        <h2>3. Mission</h2>
        <h3 id="satName" style="color: #60a5fa;">IDLE</h3>
        <p>Az: <span id="azVal" class="data">0</span>¬∞ | El: <span id="elVal" class="data">0</span>¬∞</p>
        <button id="trackBtn" class="btn-blue" onclick="toggleTrack()" disabled>START TRACKING</button>
    </div>

    <script>
        const SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const WRITE   = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
        
        let char = null;
        let sats = [];
        let running = false;

        // 1. LOCATION
        function getLocation() {
            navigator.geolocation.getCurrentPosition(p => {
                document.getElementById('lat').value = p.coords.latitude.toFixed(4);
                document.getElementById('lon').value = p.coords.longitude.toFixed(4);
            });
        }

        // 2. DATA
        async function getData() {
            document.getElementById('status').innerText = "Downloading...";
            const res = await fetch('https://celestrak.org/NORAD/elements/gp.php?GROUP=visual&FORMAT=tle');
            const txt = await res.text();
            const lines = txt.split('\n');
            sats = [];
            for(let i=0; i<lines.length; i+=3) {
                if(lines[i+1]?.startsWith('1')) sats.push({
                    name: lines[i].trim(),
                    rec: satellite.twoline2satrec(lines[i+1], lines[i+2])
                });
            }
            document.getElementById('status').innerText = `Ready! ${sats.length} Satellites.`;
        }

        // 3. CONNECT
        async function connect() {
            try {
                const dev = await navigator.bluetooth.requestDevice({
                    filters: [{namePrefix:'Pybricks'}, {namePrefix:'Robot'}],
                    optionalServices: [SERVICE]
                });
                const server = await dev.gatt.connect();
                const service = await server.getPrimaryService(SERVICE);
                char = await service.getCharacteristic(WRITE);
                document.getElementById('conBtn').innerText = "Connected!";
                document.getElementById('trackBtn').disabled = false;
            } catch(e) { alert(e); }
        }

        // 4. TRACK LOOP
        function toggleTrack() {
            running = !running;
            document.getElementById('trackBtn').innerText = running ? "STOP" : "START";
            if(running) loop();
            else send(0,0);
        }

        function loop() {
            if(!running) return;

            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);
            const obs = { 
                latitude: satellite.degreesToRadians(lat), 
                longitude: satellite.degreesToRadians(lon), 
                height: 0.03 
            };
            
            const now = new Date();
            const gmst = satellite.gstime(now);

            let best = null, maxEl = 0, bestAz = 0;

            for(let s of sats) {
                const pv = satellite.propagate(s.rec, now);
                if(!pv.position) continue;
                const look = satellite.ecfToLookAngles(obs, satellite.eciToEcf(pv.position, gmst));
                const el = satellite.radiansToDegrees(look.elevation);
                const az = satellite.radiansToDegrees(look.azimuth);

                if(el > 10 && el > maxEl) {
                    maxEl = el;
                    bestAz = az;
                    best = s.name;
                }
            }

            if(best) {
                document.getElementById('satName').innerText = best;
                document.getElementById('azVal').innerText = bestAz.toFixed(0);
                document.getElementById('elVal').innerText = maxEl.toFixed(0);
                
                // CONVERT 0-360 to -180/+180 for Robot
                let robotAz = bestAz;
                if(robotAz > 180) robotAz -= 360;
                
                send(robotAz, maxEl);
            } else {
                document.getElementById('satName').innerText = "Scanning...";
                send(0,0);
            }

            setTimeout(loop, 500);
        }

        async function send(az, el) {
            if(!char) return;
            const cmd = `${az.toFixed(1)},${el.toFixed(1)}\n`;
            try { await char.writeValue(new TextEncoder().encode(cmd)); } catch(e){}
        }
    </script>
</body>
</html>
