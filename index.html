<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #eee; }
        button { padding: 20px 40px; font-size: 20px; cursor: pointer; margin: 10px; border-radius: 10px; border: none; }
        .connect { background: #06b6d4; color: white; }
        .test { background: #3498db; color: white; }
        .stop { background: #e74c3c; color: white; }
        #log { font-family: monospace; color: #333; margin-top: 20px; }
    </style>
</head>
<body>

    <h1>ðŸ”Œ USB Protocol Fix</h1>
    <p>1. Start Robot (Cyan Light).<br>2. Plug into THIS computer.</p>

    <button id="btnCon" class="connect" onclick="connect()">1. Connect USB</button>
    <br><br>
    <button class="test" onclick="send('90,45')">Test: Spin & Tilt</button>
    <button class="stop" onclick="send('0,0')">Reset (0,0)</button>

    <div id="log">Disconnected</div>

    <script>
        let port, writer;

        async function connect() {
            if ("serial" in navigator) {
                try {
                    // Request Port
                    port = await navigator.serial.requestPort();
                    
                    // Open with standard Pybricks settings
                    await port.open({ baudRate: 115200 });
                    
                    const encoder = new TextEncoderStream();
                    encoder.readable.pipeTo(port.writable);
                    writer = encoder.writable.getWriter();

                    document.getElementById('log').innerText = "CONNECTED! Ready to send.";
                    document.getElementById('btnCon').disabled = true;
                    document.getElementById('btnCon').innerText = "USB Active";
                } catch(e) {
                    document.getElementById('log').innerText = "Error: " + e;
                }
            } else {
                alert("Please use Chrome or Edge.");
            }
        }

        async function send(msg) {
            if(!writer) return alert("Not Connected");
            
            // THE FIX: Send both Carriage Return (\r) and New Line (\n)
            const data = msg + "\r\n";
            
            await writer.write(data);
            document.getElementById('log').innerText = "Sent: " + msg;
        }
    </script>
</body>
</html>
