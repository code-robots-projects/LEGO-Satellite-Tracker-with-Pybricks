<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LEGO Tracker (Diagnostic Mode)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.1.3/satellite.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; text-align: center; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: #1e293b; padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 1px solid #334155; }
        
        button { padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; flex: 1; margin: 5px; color: white; }
        .btn-blue { background: #3b82f6; }
        .btn-green { background: #10b981; }
        .btn-orange { background: #f59e0b; }
        
        input { padding: 10px; border-radius: 5px; width: 80px; text-align: center; }
        #log { color: #22c55e; font-family: monospace; margin-top: 10px; min-height: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸ”§ Diagnostic Mode</h1>

    <div class="card">
        <h3>1. Connect</h3>
        <p>Make sure Hub light is GREEN (Calibrated).</p>
        <button class="btn-green" id="btnConnect" onclick="connectBluetooth()">ðŸ“¡ Connect Bluetooth</button>
    </div>

    <div class="card">
        <h3>2. Motor Test (Force Move)</h3>
        <p>Click these to force the motors to move.</p>
        <div style="display: flex;">
            <button class="btn-orange" onclick="sendTest(45, 0)">Spin Right (45Â°)</button>
            <button class="btn-orange" onclick="sendTest(-45, 0)">Spin Left (-45Â°)</button>
        </div>
        <div style="display: flex;">
            <button class="btn-orange" onclick="sendTest(0, 45)">Look Up (45Â°)</button>
            <button class="btn-orange" onclick="sendTest(0, 0)">Reset (0,0)</button>
        </div>
    </div>

    <div class="card">
        <h3>3. Real Tracking</h3>
        <button class="btn-blue" onclick="downloadData()">ðŸ“¥ Get Data</button>
        <br><br>
        <button id="btnTrack" class="btn-blue" onclick="toggleTracking()" disabled>START AUTO-TRACKING</button>
        <h2 id="satName" style="color: #60a5fa;">-- IDLE --</h2>
        <div id="log">Ready.</div>
    </div>
    
    <input type="hidden" id="lat" value="34.05">
    <input type="hidden" id="lon" value="-118.25">
</div>

<script>
    const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const WRITE_UUID   = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';

    let satellites = [];
    let bleChar = null;
    let isTracking = false;

    function log(msg) { document.getElementById('log').innerText = msg; }

    // --- CONNECT ---
    async function connectBluetooth() {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'Pybricks' }, { namePrefix: 'Robot' }],
                optionalServices: [SERVICE_UUID]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            bleChar = await service.getCharacteristic(WRITE_UUID);

            document.getElementById('btnConnect').innerText = "Connected!";
            document.getElementById('btnConnect').disabled = true;
            document.getElementById('btnTrack').disabled = false;
            log("Connected. Try the Orange Buttons!");
        } catch(e) { alert("Connection failed: " + e); }
    }

    // --- MANUAL TEST ---
    async function sendTest(az, el) {
        if(!bleChar) return alert("Connect Bluetooth first!");
        // Stop auto-tracking so it doesn't fight us
        isTracking = false; 
        document.getElementById('btnTrack').innerText = "START AUTO-TRACKING";
        
        log(`Sending Test: ${az}, ${el}`);
        await sendToRobot(az, el);
    }

    async function sendToRobot(az, el) {
        if(!bleChar) return;
        const cmd = `${az.toFixed(1)},${el.toFixed(1)}\n`;
        try {
            await bleChar.writeValue(new TextEncoder().encode(cmd));
        } catch(e) { console.log(e); }
    }

    // --- AUTO TRACKING ---
    async function downloadData() {
        log("Downloading...");
        const res = await fetch('https://celestrak.org/NORAD/elements/gp.php?GROUP=visual&FORMAT=tle');
        const txt = await res.text();
        const lines = txt.split('\n');
        satellites = [];
        for(let i=0; i<lines.length; i+=3) {
            if(lines[i+1]?.startsWith('1')) satellites.push({ rec: satellite.twoline2satrec(lines[i+1], lines[i+2]), name: lines[i].trim() });
        }
        log("Data Loaded. Click Start.");
        // Auto-detect location for ease
        navigator.geolocation.getCurrentPosition(p => {
            document.getElementById('lat').value = p.coords.latitude;
            document.getElementById('lon').value = p.coords.longitude;
        });
    }

    function toggleTracking() {
        isTracking = !isTracking;
        if(isTracking) {
            document.getElementById('btnTrack').innerText = "STOP";
            runLoop();
        } else {
            document.getElementById('btnTrack').innerText = "START";
        }
    }

    function runLoop() {
        if(!isTracking) return;
        
        const lat = parseFloat(document.getElementById('lat').value);
        const lon = parseFloat(document.getElementById('lon').value);
        const observer = { latitude: satellite.degreesToRadians(lat), longitude: satellite.degreesToRadians(lon), height: 0.03 };
        const now = new Date();
        const gmst = satellite.gstime(now);

        let bestSat = null;
        let maxEl = 0;
        let bestAz = 0;

        for(let s of satellites) {
            const pv = satellite.propagate(s.rec, now);
            if(!pv.position) continue;
            const look = satellite.ecfToLookAngles(observer, satellite.eciToEcf(pv.position, gmst));
            const el = satellite.radiansToDegrees(look.elevation);
            const az = satellite.radiansToDegrees(look.azimuth);

            if(el > 10 && el > maxEl) {
                maxEl = el;
                bestAz = az;
                bestSat = s.name;
            }
        }

        if(bestSat) {
            document.getElementById('satName').innerText = bestSat;
            log(`Tracking: Az ${bestAz.toFixed(0)} El ${maxEl.toFixed(0)}`);
            sendToRobot(bestAz, maxEl);
        } else {
            document.getElementById('satName').innerText = "Scanning (Sky Empty)";
            sendToRobot(0, 0);
        }
        setTimeout(runLoop, 500);
    }
</script>
</body>
</html>
