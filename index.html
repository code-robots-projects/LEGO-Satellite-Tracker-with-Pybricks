from pybricks.hubs import InventorHub
from pybricks.pupdevices import Motor
from pybricks.parameters import Port, Direction, Color, Button
from pybricks.tools import wait, StopWatch

hub = InventorHub()
az = Motor(Port.A, Direction.CLOCKWISE)
el = Motor(Port.B, Direction.COUNTERCLOCKWISE)

# --- PLACEHOLDER FOR GENERATED MISSIONS ---
# The web app will generate the full list here.
# For now, this is a blank template to prove it works.
missions = [] 

# 1. ARM (LEFT)
hub.light.on(Color.BLUE)
print("READY. PRESS LEFT TO ARM.")

# Wait for LEFT Button (Arm)
while Button.LEFT not in hub.buttons.pressed(): wait(10)
while Button.LEFT in hub.buttons.pressed(): wait(10)

# If no missions are loaded yet (just testing), wiggle to show life
if len(missions) == 0:
    hub.light.on(Color.ORANGE)
    print("NO MISSIONS LOADED. USE WEB APP TO GENERATE CODE.")
    az.run_target(500, 10)
    az.run_target(500, 0)
    wait(1000)
else:
    # Move to Mission 1 Start
    hub.light.on(Color.ORANGE)
    m1 = playlist[0]
    print("MOVING TO START: " + m1["name"])
    start_pt = m1["path"][0]
    az.run_target(500, start_pt[1], wait=False)
    el.run_target(500, start_pt[2], wait=True)

# 2. WAIT FOR LAUNCH (RIGHT)
hub.light.blink(Color.ORANGE, [200, 200])
print("PRESS RIGHT AT EXACT START TIME")
while Button.RIGHT not in hub.buttons.pressed(): wait(10)

# 3. AUTO-PLAYLIST
hub.light.on(Color.GREEN)
master_clock = StopWatch()
master_clock.reset()

# This loop only runs if you pasted the code from the Web App
for i, mission in enumerate(missions):
    print("RUNNING: " + mission["name"])
    hub.light.on(Color.GREEN)
    
    # Show Mission Number on Matrix
    hub.display.number(i + 1)
    
    target_start = mission["start_sec"] * 1000
    if i > 0:
        print("Next mission in queue...")
        hub.light.on(Color.YELLOW)
        sp = mission["path"][0]
        az.run_target(500, sp[1], wait=False)
        el.run_target(500, sp[2], wait=True)
        
        while master_clock.time() < target_start:
            wait(100)
    
    hub.light.on(Color.GREEN)
    for pt in mission["path"]:
        target_abs = target_start + (pt[0] * 1000)
        while master_clock.time() < target_abs:
            wait(10)
        az.track_target(pt[1])
        el.track_target(pt[2])

hub.light.blink(Color.GREEN, [500, 500])
print("ALL MISSIONS DONE")







