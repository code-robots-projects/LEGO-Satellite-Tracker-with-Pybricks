<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: monospace; text-align: center; padding: 20px; background: #222; color: #fff; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; margin: 10px; border-radius: 5px; border: none; }
        .btn-green { background: #2ecc71; color: white; }
        .btn-blue { background: #3498db; color: white; }
        #console { width: 80%; height: 300px; background: #000; margin: 0 auto; overflow-y: scroll; padding: 10px; border: 1px solid #444; text-align: left; }
    </style>
</head>
<body>

    <h1>üèì Connection Reality Check</h1>
    <p>1. Close ALL other tabs.<br>2. Connect.<br>3. Look for "PING" below.</p>

    <button class="btn-green" onclick="connect()">1. CONNECT</button>
    <button class="btn-blue" onclick="sendPong()">2. SEND "PONG"</button>

    <h3>Incoming Data from Robot:</h3>
    <div id="console">Waiting...</div>

    <script>
        const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const RX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // We write to this
        const TX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // We read from this

        let device, rxChar, txChar;

        function log(msg) {
            const box = document.getElementById('console');
            box.innerHTML += `<div>> ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        async function connect() {
            try {
                log("Scanning...");
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'Pybricks' }, { namePrefix: 'Robot' }],
                    optionalServices: [SERVICE_UUID]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                
                // Get Both Characteristics
                rxChar = await service.getCharacteristic(RX_CHAR_UUID); // To Robot
                txChar = await service.getCharacteristic(TX_CHAR_UUID); // From Robot

                // Setup Listener for PINGs
                await txChar.startNotifications();
                txChar.addEventListener('characteristicvaluechanged', (event) => {
                    const val = new TextDecoder().decode(event.target.value);
                    log(`<span style="color:#2ecc71">${val.trim()}</span>`);
                });

                log("CONNECTED! Waiting for Pings...");
                
            } catch(e) {
                log(`<span style="color:red">Error: ${e}</span>`);
            }
        }

        async function sendPong() {
            if(!rxChar) return log("Not Connected");
            const data = new TextEncoder().encode("X\n"); // Send a character
            
            try {
                // TRY THE "WITHOUT RESPONSE" METHOD (This is the fix!)
                if (rxChar.writeValueWithoutResponse) {
                    await rxChar.writeValueWithoutResponse(data);
                    log("Sent: PONG (NoResp)");
                } else {
                    await rxChar.writeValue(data);
                    log("Sent: PONG (Std)");
                }
            } catch(e) {
                log(`Send Error: ${e}`);
            }
        }
    </script>
</body>
</html>